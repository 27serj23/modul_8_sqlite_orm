"""
School ORM System - –í–µ—Ä—Å–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
"""

import sqlite3
import os
from typing import List, Optional, Protocol
from dataclasses import dataclass
from contextlib import contextmanager


# =============================================================================
# ENTITY LAYER
# =============================================================================

@dataclass
class Student:
    id: Optional[int] = None
    name: str = ""
    surname: str = ""
    age: int = 0
    city: str = ""

    def __str__(self) -> str:
        return f"{self.name} {self.surname}, {self.age} –ª–µ—Ç, {self.city}"

    @classmethod
    def from_row(cls, row: sqlite3.Row) -> 'Student':
        return cls(
            id=row['id'],
            name=row['name'],
            surname=row['surname'],
            age=row['age'],
            city=row['city']
        )


@dataclass
class Course:
    id: Optional[int] = None
    name: str = ""
    time_start: str = ""
    time_end: str = ""

    def __str__(self) -> str:
        return f"{self.name} ({self.time_start} - {self.time_end})"

    @classmethod
    def from_row(cls, row: sqlite3.Row) -> 'Course':
        return cls(
            id=row['id'],
            name=row['name'],
            time_start=row['time_start'],
            time_end=row['time_end']
        )


# =============================================================================
# REPOSITORY LAYER (–ë–ï–ó –ö–û–ú–ú–ò–¢–û–í!)
# =============================================================================

class StudentRepository:
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã"""
    
    def __init__(self, db_connection: sqlite3.Connection):
        self.db = db_connection
    
    def create(self, student: Student) -> int:
        cursor = self.db.cursor()
        cursor.execute(
            "INSERT INTO Students (name, surname, age, city) VALUES (?, ?, ?, ?)",
            (student.name, student.surname, student.age, student.city)
        )
        # –£–ë–†–ê–ù –∫–æ–º–º–∏—Ç - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞
        return cursor.lastrowid
    
    def get_all(self) -> List[Student]:
        cursor = self.db.cursor()
        cursor.execute("SELECT * FROM Students")
        return [Student.from_row(row) for row in cursor.fetchall()]
    
    def get_by_id(self, student_id: int) -> Optional[Student]:
        cursor = self.db.cursor()
        cursor.execute("SELECT * FROM Students WHERE id = ?", (student_id,))
        row = cursor.fetchone()
        return Student.from_row(row) if row else None
    
    def update(self, student: Student) -> bool:
        if student.id is None:
            raise ValueError("–ù–µ–ª—å–∑—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ –±–µ–∑ ID")
            
        cursor = self.db.cursor()
        cursor.execute(
            "UPDATE Students SET name = ?, surname = ?, age = ?, city = ? WHERE id = ?",
            (student.name, student.surname, student.age, student.city, student.id)
        )
        # –£–ë–†–ê–ù –∫–æ–º–º–∏—Ç
        return cursor.rowcount > 0
    
    def delete(self, student_id: int) -> bool:
        cursor = self.db.cursor()
        cursor.execute("DELETE FROM Students WHERE id = ?", (student_id,))
        # –£–ë–†–ê–ù –∫–æ–º–º–∏—Ç
        return cursor.rowcount > 0
    
    def get_by_age_gt(self, age: int) -> List[Student]:
        cursor = self.db.cursor()
        cursor.execute("SELECT * FROM Students WHERE age > ?", (age,))
        return [Student.from_row(row) for row in cursor.fetchall()]
    
    def get_by_city(self, city: str) -> List[Student]:
        cursor = self.db.cursor()
        cursor.execute("SELECT * FROM Students WHERE city = ?", (city,))
        return [Student.from_row(row) for row in cursor.fetchall()]
    
    def count(self) -> int:
        cursor = self.db.cursor()
        cursor.execute("SELECT COUNT(*) as count FROM Students")
        return cursor.fetchone()['count']


class CourseRepository:
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è"""
    
    def __init__(self, db_connection: sqlite3.Connection):
        self.db = db_connection
    
    def create(self, course: Course) -> int:
        cursor = self.db.cursor()
        cursor.execute(
            "INSERT INTO Courses (name, time_start, time_end) VALUES (?, ?, ?)",
            (course.name, course.time_start, course.time_end)
        )
        # –£–ë–†–ê–ù –∫–æ–º–º–∏—Ç
        return cursor.lastrowid
    
    def get_all(self) -> List[Course]:
        cursor = self.db.cursor()
        cursor.execute("SELECT * FROM Courses")
        return [Course.from_row(row) for row in cursor.fetchall()]
    
    def get_by_id(self, course_id: int) -> Optional[Course]:
        cursor = self.db.cursor()
        cursor.execute("SELECT * FROM Courses WHERE id = ?", (course_id,))
        row = cursor.fetchone()
        return Course.from_row(row) if row else None
    
    def get_by_name(self, name: str) -> Optional[Course]:
        cursor = self.db.cursor()
        cursor.execute("SELECT * FROM Courses WHERE name = ?", (name,))
        row = cursor.fetchone()
        return Course.from_row(row) if row else None
    
    def count(self) -> int:
        cursor = self.db.cursor()
        cursor.execute("SELECT COUNT(*) as count FROM Courses")
        return cursor.fetchone()['count']


class EnrollmentRepository:
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è"""
    
    def __init__(self, db_connection: sqlite3.Connection):
        self.db = db_connection
    
    def enroll(self, student_id: int, course_id: int) -> bool:
        try:
            cursor = self.db.cursor()
            cursor.execute(
                "INSERT INTO Student_Courses (student_id, course_id) VALUES (?, ?)",
                (student_id, course_id)
            )
            # –£–ë–†–ê–ù –∫–æ–º–º–∏—Ç
            return True
        except sqlite3.IntegrityError:
            return False
    
    def unenroll(self, student_id: int, course_id: int) -> bool:
        cursor = self.db.cursor()
        cursor.execute(
            "DELETE FROM Student_Courses WHERE student_id = ? AND course_id = ?",
            (student_id, course_id)
        )
        # –£–ë–†–ê–ù –∫–æ–º–º–∏—Ç
        return cursor.rowcount > 0
    
    def get_students_on_course(self, course_name: str) -> List[Student]:
        cursor = self.db.cursor()
        cursor.execute('''
            SELECT s.* 
            FROM Students s
            JOIN Student_Courses sc ON s.id = sc.student_id
            JOIN Courses c ON sc.course_id = c.id
            WHERE c.name = ?
        ''', (course_name,))
        return [Student.from_row(row) for row in cursor.fetchall()]
    
    def get_students_on_course_from_city(self, course_name: str, city: str) -> List[Student]:
        cursor = self.db.cursor()
        cursor.execute('''
            SELECT s.* 
            FROM Students s
            JOIN Student_Courses sc ON s.id = sc.student_id
            JOIN Courses c ON sc.course_id = c.id
            WHERE c.name = ? AND s.city = ?
        ''', (course_name, city))
        return [Student.from_row(row) for row in cursor.fetchall()]


# =============================================================================
# SERVICE LAYER (–£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–ú–ò)
# =============================================================================

class SchoolService:
    """
    –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏–π.
    –¢–µ–ø–µ—Ä—å —Ä–µ—à–∞–µ—Ç –ö–û–ì–î–ê –∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.
    """
    
    def __init__(self, db_connection: sqlite3.Connection):
        self.db = db_connection
        self.students = StudentRepository(db_connection)
        self.courses = CourseRepository(db_connection)
        self.enrollments = EnrollmentRepository(db_connection)
    
    def commit(self) -> None:
        """–Ø–≤–Ω—ã–π –∫–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"""
        self.db.commit()
    
    def rollback(self) -> None:
        """–û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"""
        self.db.rollback()
    
    @contextmanager
    def transaction(self):
        """
        –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–º–º–∏—Ç–∏—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ –∏–ª–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ.
        
        Usage:
            with service.transaction():
                service.create_student(...)
                service.enroll_student(...)
        """
        try:
            yield self
            self.db.commit()
        except Exception:
            self.db.rollback()
            raise
    
    # –ë–∏–∑–Ω–µ—Å-–º–µ—Ç–æ–¥—ã —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
    def create_student_with_enrollment(self, student_data: dict, course_ids: List[int]) -> int:
        """
        –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ + –∑–∞–ø–∏—Å—å –Ω–∞ –∫—É—Ä—Å—ã.
        –õ–∏–±–æ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–∞.
        """
        with self.transaction():
            # –°–æ–∑–¥–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞
            student = Student(**student_data)
            student_id = self.students.create(student)
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞ –∫—É—Ä—Å—ã
            for course_id in course_ids:
                if not self.enrollments.enroll(student_id, course_id):
                    raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–∞ –∫—É—Ä—Å {course_id}")
            
            return student_id
    
    def transfer_student(self, student_id: int, new_city: str, new_courses: List[int]) -> bool:
        """
        –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ + —Å–º–µ–Ω–∞ –∫—É—Ä—Å–æ–≤.
        """
        with self.transaction():
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
            student = self.students.get_by_id(student_id)
            if not student:
                return False
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥
            student.city = new_city
            if not self.students.update(student):
                return False
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å—ã
            # (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã)
            # –ó–¥–µ—Å—å –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —É–¥–∞–ª—è–µ–º –≤—Å–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –Ω–æ–≤—ã–µ –∫—É—Ä—Å—ã
            for course_id in new_courses:
                if not self.enrollments.enroll(student_id, course_id):
                    raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –∫—É—Ä—Å {course_id}")
            
            return True
    
    def get_students_count(self) -> int:
        return self.students.count()
    
    def get_courses_count(self) -> int:
        return self.courses.count()


# =============================================================================
# DATABASE LAYER
# =============================================================================

class DatabaseManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä –ë–î —Ç–µ–ø–µ—Ä—å –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ.
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–æ —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É —Å–ª–æ—é.
    """
    
    def __init__(self, db_name: str = 'school_transactional.db'):
        self.db_name = db_name
        self.conn: Optional[sqlite3.Connection] = None
    
    def __enter__(self) -> SchoolService:
        self.conn = sqlite3.connect(self.db_name)
        self.conn.row_factory = sqlite3.Row
        
        # –í–∫–ª—é—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π
        self.conn.execute("PRAGMA foreign_keys = ON")
        
        self._create_tables()
        return SchoolService(self.conn)
    
    def __exit__(self, exc_type: Optional[type], exc_val: Optional[Exception], exc_tb: Optional[object]) -> None:
        """
        –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –ù–ï –∫–æ–º–º–∏—Ç–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É —Å–ª–æ—é —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.
        """
        if self.conn:
            # –í—Å–µ–≥–¥–∞ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –Ω–µ–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
            # –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ, —á–µ–º –Ω–µ—è–≤–Ω—ã–π –∫–æ–º–º–∏—Ç
            self.conn.rollback()
            self.conn.close()
    
    def _create_tables(self) -> None:
        """–°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã —Å —è–≤–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º —Ç–æ–ª—å–∫–æ –¥–ª—è DDL"""
        cursor = self.conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS Students(
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                surname TEXT NOT NULL,
                age INTEGER NOT NULL CHECK (age > 0),
                city TEXT NOT NULL
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS Courses(
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT UNIQUE NOT NULL,
                time_start TEXT NOT NULL,
                time_end TEXT NOT NULL
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS Student_Courses(
                student_id INTEGER,
                course_id INTEGER,
                FOREIGN KEY (student_id) REFERENCES Students(id) ON DELETE CASCADE,
                FOREIGN KEY (course_id) REFERENCES Courses(id) ON DELETE CASCADE,
                PRIMARY KEY (student_id, course_id)
            )
        ''')
        
        # –ö–æ–º–º–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π DDL (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü)
        self.conn.commit()


# =============================================================================
# UI LAYER (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô –° –£–ü–†–ê–í–õ–ï–ù–ò–ï–ú –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–ú–ò)
# =============================================================================

def menu_manage_students(service: SchoolService) -> None:
    """–ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏"""
    
    def add_student() -> None:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º"""
        clear_screen()
        print_header("–î–û–ë–ê–í–õ–ï–ù–ò–ï –°–¢–£–î–ï–ù–¢–ê")
        
        try:
            student = input_student_data()
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
            with service.transaction():
                student_id = service.students.create(student)
                print(f"\n‚úÖ –°—Ç—É–¥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! ID: {student_id}")
                
        except Exception as e:
            print(f"\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: {e}")
        
        wait_for_enter()
    
    def update_student() -> None:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º"""
        clear_screen()
        print_header("–û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–£–î–ï–ù–¢–ê")
        
        students = service.students.get_all()
        if not students:
            print("‚ùå –í –±–∞–∑–µ –Ω–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
            wait_for_enter()
            return
        
        show_students_table(students)
        
        try:
            student_id = int(input("\n–í–≤–µ–¥–∏—Ç–µ ID —Å—Ç—É–¥–µ–Ω—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: "))
            existing_student = service.students.get_by_id(student_id)
            
            if not existing_student:
                print(f"‚ùå –°—Ç—É–¥–µ–Ω—Ç —Å ID {student_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            else:
                student = input_student_data(existing_student)
                
                # –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                with service.transaction():
                    if service.students.update(student):
                        print("\n‚úÖ –î–∞–Ω–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!")
                    else:
                        print("\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö")
                        
        except ValueError:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            
        wait_for_enter()
    
    def delete_student() -> None:
        """–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º –∫–æ–º–º–∏—Ç–æ–º"""
        clear_screen()
        print_header("–£–î–ê–õ–ï–ù–ò–ï –°–¢–£–î–ï–ù–¢–ê")
        
        students = service.students.get_all()
        if not students:
            print("‚ùå –í –±–∞–∑–µ –Ω–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")
            wait_for_enter()
            return
        
        show_students_table(students)
        
        try:
            student_id = int(input("\n–í–≤–µ–¥–∏—Ç–µ ID —Å—Ç—É–¥–µ–Ω—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: "))
            
            confirm = input("–í—ã —É–≤–µ—Ä–µ–Ω—ã? (–¥/–Ω): ").strip().lower()
            if confirm in ['–¥', '–¥–∞', 'y', 'yes']:
                # –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
                with service.transaction():
                    if service.students.delete(student_id):
                        print("‚úÖ –°—Ç—É–¥–µ–Ω—Ç —É–¥–∞–ª–µ–Ω!")
                    else:
                        print(f"‚ùå –°—Ç—É–¥–µ–Ω—Ç —Å ID {student_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            else:
                print("‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")
                
        except ValueError:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID")
            
        wait_for_enter()
    
    # –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
    while True:
        clear_screen()
        print_header("–£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–£–î–ï–ù–¢–ê–ú–ò")
        print(f"üìä –í –±–∞–∑–µ: {service.get_students_count()} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤")
        
        print("\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:")
        print("1. üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤")
        print("2. üÜï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞")
        print("3. ‚úèÔ∏è  –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç–∞")
        print("4. üóëÔ∏è  –£–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞")
        print("5. üîç –ù–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ –ø–æ ID")
        print("0. ‚Ü©Ô∏è  –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
        
        choice = input("\n–í–∞—à –≤—ã–±–æ—Ä: ").strip()
        
        if choice == "1":
            clear_screen()
            print_header("–í–°–ï –°–¢–£–î–ï–ù–¢–´")
            students = service.students.get_all()
            show_students_table(students)
            wait_for_enter()
            
        elif choice == "2":
            add_student()
            
        elif choice == "3":
            update_student()
            
        elif choice == "4":
            delete_student()
            
        elif choice == "5":
            clear_screen()
            print_header("–ü–û–ò–°–ö –°–¢–£–î–ï–ù–¢–ê –ü–û ID")
            try:
                student_id = int(input("–í–≤–µ–¥–∏—Ç–µ ID —Å—Ç—É–¥–µ–Ω—Ç–∞: "))
                student = service.students.get_by_id(student_id)
                
                if student:
                    print(f"\n‚úÖ –ù–∞–π–¥–µ–Ω —Å—Ç—É–¥–µ–Ω—Ç:")
                    show_students_table([student])
                else:
                    print(f"\n‚ùå –°—Ç—É–¥–µ–Ω—Ç —Å ID {student_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            except ValueError:
                print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID")
                
            wait_for_enter()
            
        elif choice == "0":
            break
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
            wait_for_enter()


def main() -> None:
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º —É–ª—É—á—à–µ–Ω–∏–π"""
    clear_screen()
    print("=" * 70)
    print("        üéì –®–ö–û–õ–¨–ù–ê–Ø ORM –°–ò–°–¢–ï–ú–ê - –¢–†–ê–ù–ó–ê–ö–¶–ò–û–ù–ù–ê–Ø –í–ï–†–°–ò–Ø")
    print("=" * 70)
    print("üìÅ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:", os.path.abspath('school_transactional.db'))
    print("\nüîÑ –£–õ–£–ß–®–ï–ù–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–ú–ò:")
    print("   ‚Ä¢ –£–±—Ä–∞–Ω—ã —á–∞—Å—Ç—ã–µ –∫–æ–º–º–∏—Ç—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤")
    print("   ‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä transaction()")
    print("   ‚Ä¢ –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏–∏")
    print("   ‚Ä¢ –Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞–º–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞")
    print("\n‚ö° –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:")
    print("   ‚Ä¢ –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î")
    print("   ‚Ä¢ –ú–µ–Ω—å—à–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫")
    print("   ‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö")
    print("   ‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π")
    print("\n–ù–∞–∂–º–∏—Ç–µ Enter —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å...")
    input()
    
    try:
        with DatabaseManager() as service:
            main_menu_updated(service)
            
        print(f"\n‚úÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        print(f"üìÅ –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {os.path.abspath('school_transactional.db')}")
        
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()


def main_menu_updated(service: SchoolService) -> None:
    """–û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    while True:
        clear_screen()
        print_header("–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ - –®–ö–û–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê")
        print(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {service.get_students_count()} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, {service.get_courses_count()} –∫—É—Ä—Å–æ–≤")
        
        print("\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:")
        print("1. üë®‚Äçüéì –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏")
        print("2. üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏")
        print("3. üìö –ó–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å—ã")
        print("4. üîç –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã")
        print("5. üíæ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è")
        print("0. üö™ –í—ã—Ö–æ–¥")
        print("-" * 50)
        
        choice = input("–í–∞—à –≤—ã–±–æ—Ä: ").strip()
        
        if choice == "1":
            menu_manage_students(service)
        elif choice == "2":
            # menu_manage_courses(service) - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å
            pass
        elif choice == "3":
            # menu_enrollments(service) - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å
            pass
        elif choice == "4":
            # menu_queries(service) - —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ, –∫–æ–º–º–∏—Ç—ã –Ω–µ –Ω—É–∂–Ω—ã
            pass
        elif choice == "5":
            service.commit()
            print("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")
            wait_for_enter()
        elif choice == "0":
            print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
            break
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
            wait_for_enter()


# –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (clear_screen, print_header, wait_for_enter, input_student_data, 
# show_students_table –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

if __name__ == "__main__":
    main()